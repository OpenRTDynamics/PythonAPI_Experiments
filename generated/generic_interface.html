<!doctype html>

<!-- <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script> -->
<script src="js/jquery-3.4.1.min.js"></script>


<html>

    <div id='simulator_gui_container'>

        <!-- <div id='editor_holder'>
            -parameters-
        </div>
        <canvas id="plot" width="400" height="200"></canvas>
        <div id='results'>
        </div> -->

    </div>
<script>

    function init_simulator_gui_container(divElement) {

        divElement.innerHTML = `
            <div id='editor_holder'>
                -parameters-
            </div>
            <canvas id="plot" width="400" height="200"></canvas>
            <div id='results'>
            </div>
        `;
    }


    function simulate(instance, manifest, dataList, Nsamples, inputValues) {

        // sort inputValues into the inupts for state update and output calculation
        var inputs_updateStates = {}
        var inputs_calcOutputs = {};
        var inputs_resetStates = {};  // normally empty

        for (var key in inputValues) {
            if (manifest.io.inputs.state_update.names.includes(key)) {
                // input 'key' is an input to the function 'updateStates'
                inputs_updateStates[key] = inputValues[key]
            }
            if (manifest.io.inputs.calculate_output.names.includes(key)) {
                // input 'key' is an input to the function 'calcOutputs'
                inputs_calcOutputs[key] = inputValues[key]
            }
        }

        instance.resetStates(inputs_resetStates);

        for (i = 0; i < Nsamples; ++i) {
            outputs = instance.calcResults_1(inputs_calcOutputs);
            instance.updateStates(inputs_updateStates);

            t = i * 0.01;

            manifest.io.outputs.calculate_output.names.forEach(function (outputName) {
                dataList[outputName][i].x = t;
                dataList[outputName][i].y = outputs[outputName];
            });
        }
    }

    function allocateOutputMemory(Nsamples) {
        var dataset_plot = [];
        for (i = 0; i < Nsamples; ++i) {
            dataset_plot.push({ x: 0.0, y: 0.0 });
        }

        return dataset_plot;
    }

    function genrateParameterInitValues(manifest) {
        // generate list of properties
        i1 = manifest.io.inputs.state_update.names.concat(manifest.io.inputs.calculate_output.names);

        var initvals = {}
        for (i = 0; i < i1.length; ++i) {
            initvals[i1[i]] = 0.1
        }

        return initvals;
    }

    function initParameterEditor(manifest, initvals, fn) {

        // Set default options
        JSONEditor.defaults.options.theme = 'bootstrap2';

        // generate list of properties
        i1 = manifest.io.inputs.state_update.names.concat(manifest.io.inputs.calculate_output.names);
        t1 = manifest.io.inputs.state_update.cpptypes.concat(manifest.io.inputs.calculate_output.cpptypes);

        var properties = {}
        for (i = 0; i < i1.length; ++i) {
            properties[i1[i]] = { "type": "number", "format": "range", "propertyOrder": i,
                "options": {
                     "infoText": "Your full name"
                }
            }
        }

        // Initialize the editor
        var editor = new JSONEditor(document.getElementById("editor_holder"), {
            schema: {
                type: "object",
                properties: properties
            }
        });

        // Set the initial inputValues
        editor.setValue(initvals);

        // Listen for changes
        editor.on("change", function () {
            fn(editor.getValue());
        });

        return editor;
    }

    function preparePlots(manifest, Nsamples) {

        // default colors
        var colorList = ['black', 'red', 'green', 'blue', 'yellow', 'grey'];

        // prepare datasets and pre alloc memory for each to fill in data
        var datasets = []
        var dataList = {}
        var i = 0
        manifest.io.outputs.calculate_output.names.forEach(function (outputName) {
            var data = allocateOutputMemory(Nsamples);

            var color;
            if (i < colorList.length) {
                color = colorList[i];
            } else {
                color = 'black'
            }

            var dataset = {
                label: outputName,
                borderColor: color,
                data: data
            };

            datasets.push(dataset);
            dataList[outputName] = data;
            i = i + 1;
        });

        // plot
        var ctx = document.getElementById('plot');

        var myLineChart = new Chart(ctx, {
            type: "scatter",
            data: { datasets },
            options: {
                animation: {
                    duration: 01 // general animation time
                },
                hover: {
                    animationDuration: 0 // duration of animations when hovering an item
                },
                responsiveAnimationDuration: 0 // animation duration after a resize
            }
        });

        return [myLineChart, dataList];
    }



    // load manifest from json file
    var p_manifest = new Promise(
        function (resolve, reject) {
            $.getJSON("simulation_manifest.json", function (json) {
                resolve(json)
            });
        });



    // load wasm file
    var rawWebAssembly = new Promise(
        function (resolve, reject) {

            console.log('loading wasm data')

            fetch('main.wasm').then(response => {
            
                console.log(response)

                resolve( response['arrayBuffer']() );

            }).then(data => { 
                console.log(data);
            });

        }
    );

    // create instance fo the simulator
    function createInstance( rawWebAssembly ) {
        var Module = {

            instantiateWasm: function (imports, successCallback) {
                console.log('creating wasm');

                return rawWebAssembly.then(function(binary) {

                        console.log('starting WebAssembly.instantiate')
                        console.log(binary);

                        var wasmInstantiate = WebAssembly.instantiate(new Uint8Array(binary), imports).then( function(output) {

                            console.log('wasm instantiation succeeded');
                            Module.testWasmInstantiationSucceeded = 1;
                            successCallback(output.instance);

                        }).catch(function(e) {
                            console.log('wasm instantiation failed! ' + e);
                        });

                    });
            },

            onRuntimeInitialized: function () {

                p_manifest.then(
                    function (manifest) {
                        console.log('loaded the following manifest')
                        console.log(manifest)

                        // init simulator
                        var instance = new Module.simulation();
                        var Nsamples = 200;

                        // init the plots
                        var [myLineChart, dataList] = preparePlots(manifest, Nsamples);

                        // parameter
                        var initvals = genrateParameterInitValues(manifest);

                        initParameterEditor(manifest, initvals, function (inputValues) {
                            // on parameter change simulate and plot
                            simulate(instance, manifest, dataList, Nsamples, inputValues);
                            myLineChart.update();
                        });

                        outputView = document.getElementById('results');

                        simulate(instance, manifest, dataList, Nsamples, initvals);
                        myLineChart.update();
                    });

                //instance.delete();
            }
        };

        return Module;
    }



    // setup
    var Module;

    function setup(rawWebAssembly) {

        init_simulator_gui_container( document.getElementById('simulator_gui_container') )
        Module = createInstance( rawWebAssembly ) 
        $.getScript('main.js')
    }

    setup(rawWebAssembly);

</script>

<!-- <script src="main.js"></script> -->
<script src="node_modules/chart.js/dist/Chart.bundle.min.js"></script>
<script src="node_modules/@json-editor/json-editor/dist/jsoneditor.js"></script>


</html>