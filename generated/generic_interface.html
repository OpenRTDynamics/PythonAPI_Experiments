<!doctype html>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>


<html>

<div id='editor_holder'>
    -parameters-
</div>

<canvas id="plot" width="400" height="200"></canvas>

<div id='results'>
    --
</div>

<script>


    function simulate(instance, manifest, dataList, Nsamples, inputValues) {

        // sort inputValues into the inupts for state update and output calculation
        var inputs_updateStates = {}
        var inputs_calcOutputs = {};
        var inputs_resetStates = {};  // normally empty

        for (var key in inputValues) {
            console.log(inputValues[key]);

            if (manifest.io.inputs.state_update.names.includes(key)) {
                inputs_updateStates[key] = inputValues[key]
            } else if (manifest.io.inputs.calculate_output.names.includes(key)) {
                inputs_calcOutputs[key] = inputValues[key]
            }

        }

        instance.resetStates(inputs_resetStates);

        for (i = 0; i < Nsamples; ++i) {
            outputs = instance.calcResults_1(inputs_calcOutputs);
            instance.updateStates(inputs_updateStates);

            t = i * 0.01;

            manifest.io.outputs.calculate_output.names.forEach(function (outputName) {
                dataList[outputName][i].x = t;
                dataList[outputName][i].y = outputs[outputName];
            });

        }

    }


    function allocateOutputMemory(Nsamples) {
        var dataset_plot = [];
        for (i = 0; i < Nsamples; ++i) {
            dataset_plot.push({ x: 0.0, y: 0.0 });
        }

        return dataset_plot;
    }


    function genrateParameterInitValues(manifest) {
        // generate list of properties
        i1 = manifest.io.inputs.state_update.names.concat(manifest.io.inputs.calculate_output.names);

        var initvals = {}
        for (i = 0; i < i1.length; ++i) {
            initvals[i1[i]] = 0.1
        }

        return initvals;
    }


    function initParameterEditor(manifest, initvals, fn) {

        // Set default options
        JSONEditor.defaults.options.theme = 'bootstrap2';

        // generate list of properties
        i1 = manifest.io.inputs.state_update.names.concat(manifest.io.inputs.calculate_output.names);
        t1 = manifest.io.inputs.state_update.cpptypes.concat(manifest.io.inputs.calculate_output.cpptypes);

        var properties = {}
        for (i = 0; i < i1.length; ++i) {
            properties[i1[i]] = { "type": "number" }
        }

        // Initialize the editor
        var editor = new JSONEditor(document.getElementById("editor_holder"), {
            schema: {
                type: "object",
                properties: properties
            }
        });

        // Set the initial inputValues
        editor.setValue(initvals);

        // Listen for changes
        editor.on("change", function () {
            // Do something...

            fn(editor.getValue());
        });

        return editor;
    }

    // load manifest from json file
    var p_manifest = new Promise(
        function (resolve, reject) {

            $.getJSON("simulation_manifest.json", function (json) {
                console.log(json);
                resolve(json)
            });
        });


    var Module = {
        onRuntimeInitialized: function () {

            p_manifest.then(
                function (manifest) {
                    console.log('manifest loaded:')
                    console.log(manifest)

                    // init simulator
                    var instance = new Module.testSimulation();
                    var Nsamples = 400;

                    // default colors
                    var colorList = ['black', 'red', 'green', 'blue', 'yellow', 'grey'];

                    // prepare datasets and pre alloc memory for each to fill in data
                    var datasets = []
                    var dataList = {}
                    var i = 0
                    manifest.io.outputs.calculate_output.names.forEach(function (outputName) {
                        var data = allocateOutputMemory(Nsamples);

                        var color;
                        if (i < colorList.length) {
                            color = colorList[i];
                        } else {
                            color = 'black'
                        }

                        var dataset = {
                            label: outputName,
                            borderColor: color,
                            data: data
                        };

                        datasets.push(dataset);
                        dataList[outputName] = data;
                        i = i + 1;
                    });

                    // plot
                    var ctx = document.getElementById('plot');

                    var myLineChart = new Chart(ctx, {
                        type: "scatter",
                        data: { datasets },
                        options: {
                            animation: {
                                duration: 01 // general animation time
                            },
                            hover: {
                                animationDuration: 0 // duration of animations when hovering an item
                            },
                            responsiveAnimationDuration: 0 // animation duration after a resize
                        }
                    });

                    // parameter
                    var initvals = genrateParameterInitValues(manifest);

                    initParameterEditor(manifest, initvals, function (inputValues) {
                        simulate(instance, manifest, dataList, Nsamples, inputValues);
                        myLineChart.update();
                    });


                    outputView = document.getElementById('results');

                    console.log('create simularion');

                    simulate(instance, manifest, dataList, Nsamples, initvals);
                    myLineChart.update();
                });

            //instance.delete();
        }
    };

</script>

<script src="main.js"></script>
<script src="node_modules/chart.js/dist/Chart.bundle.min.js"></script>
<script src="node_modules/@json-editor/json-editor/dist/jsoneditor.js"></script>


</html>