<!doctype html>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>


</html>


<html>




<div id='editor_holder'>
    -parameters-
</div>

<canvas id="plot" width="400" height="200"></canvas>

<div id='results'>
    --
</div>

<script>


    function simulate(instance, dataset_plot, Nsamples, values) {

        var inputs_updateStates = {}

        for (var key in values) {
            console.log(values[key]);

            inputs_updateStates[key] = values[key]
        }

        console.log('simulation inputs')
        console.log(inputs_updateStates)


        var inputs_resetStates = {};
        var inputs_calcOutputs = {};

        instance.resetStates(inputs_resetStates);

        for (i = 0; i < Nsamples; ++i) {
            outputs = instance.calcResults_1(inputs_calcOutputs);
            instance.updateStates(inputs_updateStates);

            t = i * 0.01;

            dataset_plot[i].x = t;
            dataset_plot[i].y = outputs.x;
        }

    }

    function genrateParameterInitValues(manifest) {
        // generate list of properties
        i1 = manifest.io.inputs.state_update.names;

        var initvals = {}
        for (i = 0; i < i1.length; ++i) {
            initvals[i1[i]] = 0.0
        }

        return initvals;
    }


    function initParameterEditor(manifest, initvals, fn) {

        // Set default options
        JSONEditor.defaults.options.theme = 'bootstrap2';

        // generate list of properties
        i1 = manifest.io.inputs.state_update.names;
        t1 = manifest.io.inputs.state_update.types;
        console.log(i1)

        var properties = {}
        for (i = 0; i < i1.length; ++i) {
            properties[i1[i]] = { "type": "number" }
        }

        console.log(properties);


        // Initialize the editor
        var editor = new JSONEditor(document.getElementById("editor_holder"), {
            schema: {
                type: "object",
                properties: properties
            }
        });

        // // Initialize the editor
        // var editor = new JSONEditor(document.getElementById("editor_holder"), {
        //     schema: {
        //         type: "object",
        //         properties: {
        //             "Kp": { "type": "number" },
        //             "Ki": { "type": "number" },
        //         }
        //     }
        // });

        // Set the value


        editor.setValue(initvals);


        // editor.setValue({
        //     "Kp": 0.123 ,
        //     "ref" : 4
        //     //"Ki": 0
        // });

        // Listen for changes
        editor.on("change", function () {
            // Do something...

            fn(editor.getValue());
        });

        return editor;
    }

    var tmp;

    // load manifest from json file
    var p_manifest = new Promise(
        function (resolve, reject) {

            $.getJSON("simulation_manifest.json", function (json) {
                console.log(json);
                resolve(json)
            });

        });


    var Module = {
        onRuntimeInitialized: function () {

            p_manifest.then(
                function (manifest) {
                    console.log('manifest loaded:')
                    console.log(manifest)

                    // init simulator
                    var instance = new Module.testSimulation();
                    var Nsamples = 400;

                    // pre alloc memory
                    var dataset_plot = [];
                    for (i = 0; i < Nsamples; ++i) {
                        dataset_plot.push({ x: 0.0, y: 0.0 });
                    }

                    // plot
                    var ctx = document.getElementById('plot');

                    var s1 = {
                        label: 'intX_y',
                        borderColor: 'red',
                        data: dataset_plot
                    };

                    var myLineChart = new Chart(ctx, {
                        // type: 'line',
                        type: "scatter",

                        data: { datasets: [s1] },

                        options: {

                            // animation: {
                            //   duration: 1 // general animation time
                            // },
                            // hover: {
                            //   animationDuration: 0 // duration of animations when hovering an item
                            // },
                            // responsiveAnimationDuration: 0 // animation duration after a resize
                        }
                    });


                    // parameter
                    var initvals = genrateParameterInitValues(manifest);

                    initParameterEditor(manifest, initvals, function (values) {
                        console.log(values);

                        // simulate(instance, dataset_plot, Nsamples,
                        //     {
                        //         Kp: parseFloat(values.Kp),
                        //         ref: parseFloat(values.ref)
                        //     });

                        simulate(instance, dataset_plot, Nsamples, values);


                        myLineChart.update();
                    });


                    outputView = document.getElementById('results');


                    console.log('create simularion');

                    simulate(instance, dataset_plot, Nsamples, initvals );
                    myLineChart.update();
                });

            //instance.delete();

        }
    };

</script>

<script src="main.js"></script>
<script src="node_modules/chart.js/dist/Chart.bundle.min.js"></script>
<script src="node_modules/@json-editor/json-editor/dist/jsoneditor.js"></script>


</html>